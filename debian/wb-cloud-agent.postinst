#!/bin/bash

set -e

# remove stall activation link file if updated from <=1.2.6
if [ "$1" = "configure" ] && dpkg --compare-versions "$2" lt "1.2.7~~"; then
    if [ -e "/var/lib/wb-cloud-agent/telegraf.conf" ] && [ -e "/var/lib/wb-cloud-agent/activation_link.conf" ]; then
        echo "Controller seems to be in the cloud already, removing stall activation link"
        echo "unknown" > "/var/lib/wb-cloud-agent/activation_link.conf"
    fi
fi

# fix agent config (ATECC path according to device version)
. /usr/lib/wb-utils/wb_env.sh
wb_source of

if of_machine_match "wirenboard,wirenboard-720"; then
    sed -i 's/ATECCx08:00:../ATECCx08:00:02/g' "$AGENT_CONFIG"
elif of_machine_match "contactless,imx6ul-wirenboard60"; then
    sed -i 's/ATECCx08:00:../ATECCx08:00:04/g' "$AGENT_CONFIG"
fi

#DEBHELPER#
